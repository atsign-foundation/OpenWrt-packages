# Package: net/csshnpd

This package contains the
[C NoPorts daemon](https://github.com/atsign-foundation/noports/tree/trunk/packages/c/sshnpd)

NoPorts can be used to connect to a device using TCP protocols such as SSH
without needing an open port exposed to the Internet.

Before installing NoPorts on OpenWrt it's recommended that you install the
NoPorts client and activate client and device keys on the machine you're
going to connect from.

The [installation overview](https://docs.noports.com/installation) gives
a high level run through of the process, and specific guides for Linux,
MacOS and Windows can be found in the navigation bar of that page.

## Installing csshnpd

### LuCI installation

Browse to System > Software then type `cssh` into the Filter: box.

Then press the `Install...` button beside the csshnpd package.

It is recommended that you also install the `luci-app-csshnpd` package
to enable configuration in LuCI.

### CLI installation

To install on snapshot OpenWrt:

```sh
apk update
apk add csshnpd
```

For older versions please refer to the
[OpenWrt Installation Guide](https://docs.noports.com/installation/openwrt-installation-guide)

## Configuring the sshnpd service

### LuCI configuration

With the `luci-app-csshnpd` package installed (see above) a `NoPorts` submenu
will appear in the `Network` dropdown.

Fill out the fields on the `NoPorts Config` tab then press `Save & Apply`.

The Enrollment OTP/STP can be generated on the client machine where the
device and manager (client) atSigns have been activated. Run:

```sh
at_activate otp -a ${DeviceAtsign}
```

### CLI configuration

The config is held in `/etc/config/sshnpd`

Use your favourite editor to set `atsign`, `manager` and `device` to the
atSigns and name you wish to use.

`enabled` needs to be changed to `1`

The `otp` should be set to the OTP (or STP) created for the device atSign
enrollment:

```sh
at_activate otp -a ${DeviceAtsign}
```

## Key Enrollment

An atKeys file can be generated by using the enrollment process.

### LuCI enrollment

After copying the OTP/STP in place (see above), click on the
`NoPorts Enrollment` tab.

The approval command will be displayed so that it can be copied
and pasted into the client machine.

Press the `Enroll` button then go to the client and run the (copied) approval
command.

Enrollment should now complete, with logs showing that an atKeys file has been
written.

Once enrolled the `NoPorts` Enrollment tab will show an `Existing key found`
message.

### CLI enrollment

Run:

```sh
at_enroll.sh
```

The script will prompt for approval of the enrollment on your client and
provide the command to be run there.

## Starting the daemon

### LuCI startup

Browse to System > Startup.

Scroll down to `sshnpd` and press `Start`

### CLI startup

Run:

```sh
/etc/init.d/sshnpd start
```

## Connecting using sshnp

From your client machine run:

```sh
sshnp -f ${ManagerAtsign} -t ${DeviceAtsign}$ -d ${DeviceName} -h rv_eu
```

NB `rv_eu` is the Europe relay, use `rv_am` if you're in the Americas or
`rv_ap` if you're in Asia-Pacific.


## Maintainers

Created by [@cpswan](https://github.com/cpswan)
